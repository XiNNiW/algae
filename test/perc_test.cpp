
#include "algae.h"
#include <gtest/gtest.h>
#include <iostream>

using algae::dsp::control::Perc;

TEST(DSP_Test, CorePercTest) {
  const size_t blocksize = 48;
  const float samplerate = 1000;

  auto env = Perc<float>();

  ASSERT_EQ(0, env.next());
  ASSERT_EQ(0, env.next());
  ASSERT_EQ(0, env.next());
  env.set(4, 4, 1, samplerate);

  float signal[blocksize];
  env.trigger();
  env.process(signal, blocksize, signal);

  float expected[blocksize] = {
      0.004999999888241291, 0.0074999998323619366, 0.022553015500307083,
      0.081987187266349792, 0.30690839886665344,   0.15845419466495514,
      0.098030112683773041, 0.11972573399543762,   0.064862869679927826,
      0.037431433796882629, 0.037518732249736786,  0.023759365081787109,
      0.016879681497812271, 0.027242856100201607,  0.084332108497619629,
      0.047166053205728531, 0.042386040091514587,  0.02619301900267601,
      0.031899522989988327, 0.020949762314558029,  0.029277896508574486,
      0.019638948142528534, 0.028622489422559738,  0.019311245530843735,
      0.014655622653663158, 0.012327810749411583,  0.024966919794678688,
      0.017483459785580635, 0.027544744312763214,  0.018772371113300323,
      0.028189200907945633, 0.019094601273536682,  0.014547300525009632,
      0.026076665148139,    0.083749011158943176,  0.046874504536390305,
      0.042240265756845474, 0.026120133697986603,  0.018060065805912018,
      0.02783304825425148,  0.018916524946689606,  0.028261277824640274,
      0.084841318428516388, 0.04742065817117691,   0.042513344436883926,
      0.026256673038005829, 0.031931351870298386,  0.020965676754713058,
  };
  std::cout.precision(17);
  std::cout << "\n{";
  for (size_t i = 0; i < blocksize; i++) {
    // ASSERT_NEAR(expected[i], signal[i], 0.01);
    std::cout << signal[i] << ",";
  }
  std::cout << "}\n";
  // ASSERT_TRUE(false);
}
